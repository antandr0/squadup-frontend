const API_BASE_URL = import.meta.env.VITE_API_URL || 'https://squadup-backend-03vr.onrender.com';

// üöÄ –°–ò–°–¢–ï–ú–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø
class CacheService {
  constructor() {
    this.cache = new Map();
    this.defaultTTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
  }

  set(key, data, ttl = this.defaultTTL) {
    this.cache.set(key, {
      data,
      expiry: Date.now() + ttl,
      ttl
    });
  }

  get(key) {
    const item = this.cache.get(key);
    if (!item) return null;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ TTL
    if (Date.now() > item.expiry) {
      this.cache.delete(key);
      return null;
    }

    return item.data;
  }

  delete(key) {
    this.cache.delete(key);
  }

  clear() {
    this.cache.clear();
  }

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  getStats() {
    const now = Date.now();
    let valid = 0, expired = 0;
    
    this.cache.forEach(item => {
      if (now > item.expiry) expired++;
      else valid++;
    });

    return {
      total: this.cache.size,
      valid,
      expired,
      hitRate: this.getHitRate()
    };
  }

  getHitRate() {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è hit rate
    return this.cache.size > 0 ? Math.round((valid / this.cache.size) * 100) : 0;
  }
}

class ApiService {
  constructor() {
    this.baseURL = API_BASE_URL;
    this.isDemoMode = false;
    this.cache = new CacheService();
    this.requestQueue = new Map(); // –î–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    this.requestStats = {
      total: 0,
      cached: 0,
      network: 0
    };
  }

  // üéØ –£–õ–£–ß–®–ï–ù–ù–´–ô –ú–ï–¢–û–î –ó–ê–ü–†–û–°–ê –° –ö–≠–®–ò–†–û–í–ê–ù–ò–ï–ú
  async request(endpoint, options = {}) {
    const token = localStorage.getItem('token');
    const method = options.method || 'GET';
    const useCache = options.useCache !== false && method === 'GET';
    const cacheKey = this.generateCacheKey(endpoint, options);

    // üî• –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–´–• –ó–ê–ü–†–û–°–û–í
    if (this.requestQueue.has(cacheKey)) {
      console.log(`üîÑ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞: ${cacheKey}`);
      return this.requestQueue.get(cacheKey);
    }

    // üî• –ü–†–û–í–ï–†–ö–ê –ö–≠–®–ê –î–õ–Ø GET –ó–ê–ü–†–û–°–û–í
    if (useCache) {
      const cachedData = this.cache.get(cacheKey);
      if (cachedData) {
        console.log(`üíæ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è: ${endpoint}`);
        this.requestStats.cached++;
        this.requestStats.total++;
        return cachedData;
      }
    }

    const config = {
      headers: {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` }),
        ...options.headers,
      },
      ...options,
    };

    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–∏—Å –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
    const requestPromise = (async () => {
      try {
        console.log(`üåê –°–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å: ${this.baseURL}${endpoint}`);
        const response = await fetch(`${this.baseURL}${endpoint}`, config);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // üî• –ö–≠–®–ò–†–£–ï–ú –£–°–ü–ï–®–ù–´–ï GET –ó–ê–ü–†–û–°–´
        if (useCache && data.success !== false) {
          const ttl = this.getTTLForEndpoint(endpoint);
          this.cache.set(cacheKey, data, ttl);
          console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –≤ –∫—ç—à: ${endpoint} (TTL: ${ttl/1000}s)`);
        }

        this.requestStats.network++;
        this.requestStats.total++;
        
        return data;
      } catch (error) {
        console.warn(`‚ùå API Failed: ${error.message}, using demo mode`);
        this.isDemoMode = true;
        
        // –ù–µ –∫—ç—à–∏—Ä—É–µ–º demo responses
        const demoData = await this.getDemoResponse(endpoint, options);
        this.requestStats.network++;
        this.requestStats.total++;
        return demoData;
      } finally {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        this.requestQueue.delete(cacheKey);
      }
    })();

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
    this.requestQueue.set(cacheKey, requestPromise);
    return requestPromise;
  }

  // üéØ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–õ–Æ–ß–ê –ö–≠–®–ê
  generateCacheKey(endpoint, options) {
    const body = options.body ? JSON.stringify(options.body) : '';
    return `${endpoint}|${body}|${options.method || 'GET'}`;
  }

  // üéØ TTL –î–õ–Ø –†–ê–ó–ù–´–• ENDPOINTS
  getTTLForEndpoint(endpoint) {
    const ttlConfig = {
      '/api/profiles': 2 * 60 * 1000, // 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
      '/api/auth/me': 5 * 60 * 1000,  // 5 –º–∏–Ω—É—Ç –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      '/health': 30 * 1000,           // 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è health check
      default: 5 * 60 * 1000          // 5 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    };

    return ttlConfig[endpoint] || ttlConfig.default;
  }

  // üéØ –ú–ï–¢–û–î–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–≠–®–ï–ú
  clearCache() {
    this.cache.clear();
    console.log('üßπ –ö—ç—à –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω');
  }

  invalidateEndpoint(endpointPattern) {
    let cleared = 0;
    for (const key of this.cache.cache.keys()) {
      if (key.includes(endpointPattern)) {
        this.cache.delete(key);
        cleared++;
      }
    }
    console.log(`üßπ –û—á–∏—â–µ–Ω–æ ${cleared} –∑–∞–ø–∏—Å–µ–π –∫—ç—à–∞ –¥–ª—è: ${endpointPattern}`);
  }

  getCacheStats() {
    return {
      cache: this.cache.getStats(),
      requests: this.requestStats
    };
  }

  // üîß –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ú–ï–¢–û–î–´ –° –ö–≠–®–ò–†–û–í–ê–ù–ò–ï–ú
  async login(email, password) {
    // –ù–µ –∫—ç—à–∏—Ä—É–µ–º –ª–æ–≥–∏–Ω
    const response = await this.request('/api/auth/login', {
      method: 'POST',
      body: JSON.stringify({ email, password }),
      useCache: false
    });
    
    if (response.token && response.user) {
      localStorage.setItem('token', response.token);
      // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      this.invalidateEndpoint('/api/profiles');
      this.invalidateEndpoint('/api/auth/me');
      return { success: true, user: response.user };
    } else if (response.error) {
      return { success: false, error: response.error };
    }
    
    return { success: false, error: '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏' };
  }

  async register(email, password, nickname) {
    // –ù–µ –∫—ç—à–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    const response = await this.request('/api/auth/register', {
      method: 'POST',
      body: JSON.stringify({ email, password, nickname }),
      useCache: false
    });
    
    if (response.token && response.user) {
      localStorage.setItem('token', response.token);
      return { success: true, user: response.user };
    } else if (response.error) {
      return { success: false, error: response.error };
    }
    
    return { success: false, error: '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' };
  }

  async getProfiles() {
    // –ö—ç—à–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª–µ–π
    return this.request('/api/profiles', {
      useCache: true
    });
  }

  async updateProfile(profileData) {
    const response = await this.request('/api/profiles/update', {
      method: 'POST',
      body: JSON.stringify(profileData),
      useCache: false
    });
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if (response.success) {
      this.invalidateEndpoint('/api/profiles');
    }
    
    return response;
  }

  async getCurrentUser() {
    // –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    return this.request('/api/auth/me', {
      useCache: true
    });
  }

  // üîß DEMO MODE (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  getDemoResponse(endpoint, options) {
    return new Promise(resolve => {
      setTimeout(() => {
        let response;
        
        switch(endpoint) {
          case '/api/auth/login':
          case '/api/auth/register':
            const body = options.body ? JSON.parse(options.body) : {};
            response = {
              user: {
                id: "demo-" + Date.now(),
                email: body.email || "demo@user.com",
                profile: {
                  nickname: body.nickname || "DemoUser",
                  overallRating: 4.5,
                  playMode: "both",
                  age: 25,
                  aboutMe: "–î–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SquadUp",
                  games: ["Dota 2", "CS:GO"],
                  location: "–ú–æ—Å–∫–≤–∞",
                  totalReviews: 0
                }
              },
              token: "demo-token-" + Date.now()
            };
            break;
            
          case '/api/profiles':
            response = [
              {
                id: "2",
                nickname: "ProPlayer",
                isOnline: true,
                overallRating: 4.8,
                playMode: "competitive",
                age: 25,
                aboutMe: "–ò—â—É —Ç–∏–º–º–µ–π—Ç–æ–≤ –¥–ª—è —Ä–∞–Ω–≥–æ–≤—ã—Ö –∏–≥—Ä. –ò–≥—Ä–∞—é —Å–µ—Ä—å–µ–∑–Ω–æ!",
                games: ["Dota 2", "CS:GO"],
                location: "–ú–æ—Å–∫–≤–∞"
              },
              {
                id: "3", 
                nickname: "CasualGamer",
                isOnline: true,
                overallRating: 4.2,
                playMode: "casual", 
                age: 22,
                aboutMe: "–ò–≥—Ä–∞—é –¥–ª—è —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è, –±–µ–∑ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏",
                games: ["Valorant", "Overwatch 2"],
                location: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"
              }
            ];
            break;
            
          default:
            response = { success: true, demo: true };
        }
        
        resolve(response);
      }, 800);
    });
  }
}

export const apiService = new ApiService();

// üéØ HOOK –î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –í –ö–û–ú–ü–û–ù–ï–ù–¢–ê–•
export const useApiCache = () => {
  return {
    clearCache: () => apiService.clearCache(),
    invalidateEndpoint: (pattern) => apiService.invalidateEndpoint(pattern),
    getStats: () => apiService.getCacheStats()
  };
};
